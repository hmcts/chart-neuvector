{{- if .Values.keyVaults -}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-test-service"
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": test
spec:
  template:
    metadata:
      name: "{{ .Release.Name }}-test-service"
      labels:
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/name: {{ template "chart-neuvector.name" . }}
    spec:
      serviceAccountName: {{ .Release.Namespace }}
      restartPolicy: Never
      containers:
        - name: {{ .Release.Name }}-test-service
          image: hmctsprod.azurecr.io/docker-curl
          volumeMounts:
          {{- ( include "hmcts.secretMounts.v3" . ) | indent 10   }}
            - name: config-volume
              mountPath: /entrypoint
          env:
            - name: SERVICE_NAME
              value: {{ .Release.Name }}
          command: ["sh", "-c", "/entrypoint/entrypoint.sh"]
      volumes:
      {{- ( include "hmcts.secretCSIVolumes.v3" . ) | indent 6 }}
        - name: config-volume
          configMap:
            name: {{ .Release.Name }}-test-configmap
            defaultMode: 0755


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-test-configmap
  namespace: {{ .Release.Namespace }}
data:
  entrypoint.sh: |-
    #!/bin/sh

    set -e

    # NV API URL.
    API_URL="https://neuvector-svc-controller.neuvector.svc.cluster.local:10443/v1"

    # KV Flexvol secrets
    NV_NEW_ADMIN_PASSWORD=$(cat  /mnt/secrets/{{ .Values.keyvault.name }}/neuvector-new-admin-password)

    echo "Getting authentication token..."
    TOKEN=$(curl -sk -H "Content-Type: application/json" -d '{"password": {"username": "admin", "password": "'"$NV_NEW_ADMIN_PASSWORD"'"}}' "$API_URL/auth" | jq -r .token.token)
    [[ "$TOKEN" == "" || "$TOKEN" == "null" ]] && exit 1

    echo "Checking EULA accepted..."
    EULA=$(curl -sk -H "Content-Type: application/json" -H "X-Auth-Token: $TOKEN" $API_URL/eula |jq .eula.accepted)
    [ "$EULA" != "true" ] && exit 1

    exit 0
{{- end -}}

